<!DOCTYPE html>
<html lang="en" data-theme="glassmorphism">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Nexus | Universal Dashboard</title>
    <!-- 
    ================================================================================
    PROJECT NEXUS // MODULE V.11.6 (STANDARD WORKS ENTERPRISE - REFINED)
    ================================================================================
    - Core Engine: Vanilla JavaScript
    - Markdown Engine: Marked.js
    - Iconography: Lucide.js
    - Sources: BoM.txt, KJV.txt, DaC_PoGP.txt Triple-Protocol Parser
    - Status: Production Ready, Verse Labels Cleaned
    ================================================================================
    -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        /* 
        ================================================================================
        1. MASTER ARCHITECTURE & CSS VARIABLES
        ================================================================================
        - Preserving the exact requested visual style from the context provided.
        - Using Default System Typography for a clean, non-themed feel.
        */
        :root {
            /* Theme: Glassmorphism (Default) */
            --bg-primary: #0f172a;
            --bg-gradient: linear-gradient(135deg, #020617 0%, #0f172a 100%);
            --accent-color: #3b82f6;
            --accent-glow: rgba(59, 130, 246, 0.4);
            --card-bg: rgba(255, 255, 255, 0.03);
            --card-border: rgba(255, 255, 255, 0.08);
            --modal-bg: rgba(15, 23, 42, 0.98);
            --text-main: #f8fafc;
            --text-dim: #94a3b8;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --panel-blur: 32px;
            --curve: 1.5rem;
            
            /* System Default Fonts */
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            --transition-speed: 0.3s;
        }

        [data-theme="cyberpunk"] {
            --bg-primary: #050505;
            --bg-gradient: linear-gradient(180deg, #050505 0%, #1a0b2e 100%);
            --accent-color: #00ffff;
            --accent-glow: rgba(0, 255, 255, 0.5);
            --card-bg: rgba(10, 10, 10, 0.9);
            --card-border: #00ffff;
            --text-main: #00ffff;
            --text-dim: #008888;
            --panel-blur: 0px;
        }

        [data-theme="midnight"] {
            --bg-primary: #000000;
            --bg-gradient: black;
            --accent-color: #ffffff;
            --accent-glow: rgba(255, 255, 255, 0.1);
            --card-bg: #0a0a0a;
            --card-border: #222222;
            --text-main: #ffffff;
            --text-dim: #555555;
            --panel-blur: 0px;
        }

        /* 
        ================================================================================
        2. GLOBAL RESET & BOILERPLATE
        ================================================================================
        */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-font-smoothing: antialiased; }

        body {
            background: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-main);
            font-family: var(--font-main);
            min-height: 100vh;
            overflow-x: hidden;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
        }

        .nx-container { max-width: 1700px; margin: 0 auto; padding: 2rem; position: relative; z-index: 10; }

        /* 
        ================================================================================
        3. HEADER ARCHITECTURE & SCRIPTURE
        ================================================================================
        */
        .nx-header { display: flex; align-items: baseline; gap: 1.5rem; margin-bottom: 3.5rem; }
        
        .verse-aside {
            font-size: 0.85rem;
            font-style: italic;
            opacity: 0.6;
            color: var(--accent-color);
            max-width: 800px;
            line-height: 1.4;
            animation: fadeIn 2s ease;
            user-select: text;
        }

        /* 
        ================================================================================
        4. DASHBOARD GRID & CARDS
        ================================================================================
        */
        .nx-dashboard-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 1.5rem;
            grid-auto-rows: minmax(130px, auto);
        }

        .nx-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            backdrop-filter: blur(var(--panel-blur));
            border-radius: var(--curve);
            padding: 1.5rem;
            position: relative;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .nx-card:hover { border-color: var(--accent-color); box-shadow: 0 10px 40px -10px var(--accent-glow); transform: translateY(-3px); }

        .nx-card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; }

        .nx-card-title {
            font-weight: 900;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            opacity: 0.5;
            display: flex; align-items: center; gap: 0.75rem;
        }

        /* Grid Mapping */
        .grid-sm { grid-column: span 3; }
        .grid-md { grid-column: span 6; }
        .grid-lg { grid-column: span 9; }
        .grid-full { grid-column: span 12; }
        .row-2 { grid-row: span 2; }
        .row-3 { grid-row: span 3; }

        /* 
        ================================================================================
        5. NEXUS COMPONENTS: BUTTONS, INPUTS
        ================================================================================
        */
        .nx-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--card-border);
            color: var(--text-main);
            padding: 0.75rem 1.25rem;
            border-radius: 0.85rem;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 700;
            display: flex; align-items: center; gap: 0.6rem;
            transition: all 0.2s;
            outline: none;
        }

        .nx-btn:hover { background: var(--accent-color); color: white; border-color: transparent; }
        .nx-btn-icon { padding: 0.65rem; border-radius: 0.75rem; }

        .nx-input {
            background: rgba(0, 0, 0, 0.25);
            border: 1px solid var(--card-border);
            color: var(--text-main);
            padding: 0.85rem 1.15rem;
            border-radius: 0.85rem;
            width: 100%;
            outline: none;
            font-family: inherit;
            margin-bottom: 1rem;
        }

        .nx-input:focus { border-color: var(--accent-color); }

        /* 
        ================================================================================
        6. THE OMNI-MODAL SYSTEM
        ================================================================================
        Replaces all default browser popups (Alert/Prompt).
        */
        .nx-modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(20px);
            z-index: 9999;
            display: none; align-items: center; justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .nx-modal {
            background: var(--modal-bg);
            border: 1px solid var(--card-border);
            border-radius: 2.5rem;
            padding: 2.5rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 50px 100px -20px rgba(0,0,0,0.9);
            position: relative;
        }

        .nx-modal h2 { margin-bottom: 2rem; font-weight: 900; letter-spacing: -1px; }

        /* 
        ================================================================================
        7. CHRONOS TIMER CORE
        ================================================================================
        */
        .timer-display {
            font-family: var(--font-mono);
            font-size: 5rem;
            font-weight: 700;
            text-align: center;
            margin: 1.5rem 0;
            letter-spacing: -4px;
            color: var(--text-main);
            text-shadow: 0 0 30px var(--accent-glow);
        }

        .timer-controls-manual {
            display: flex; gap: 0.5rem; justify-content: center; margin-bottom: 1.5rem;
        }

        .timer-unit-input {
            width: 70px; text-align: center;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--card-border);
            border-radius: 0.75rem;
            color: white; font-family: var(--font-mono);
            padding: 0.5rem;
        }

        /* 
        ================================================================================
        8. TOASTER NOTIFICATIONS
        ================================================================================
        */
        #nx-toast-container {
            position: fixed; bottom: 2rem; right: 2rem;
            z-index: 10000; display: flex; flex-direction: column; gap: 1rem;
        }

        .nx-toast {
            background: var(--modal-bg);
            border-left: 5px solid var(--accent-color);
            padding: 1.25rem 2rem;
            border-radius: 1rem;
            color: white; font-weight: 600; font-size: 0.9rem;
            box-shadow: 0 15px 40px rgba(0,0,0,0.5);
            animation: slideInRight 0.4s ease;
            display: flex; align-items: center; gap: 1rem;
        }

        /* 
        ================================================================================
        9. HABIT 3.0 & TODO PERSISTENCE
        ================================================================================
        - Done tasks cross out and move to bottom.
        - 5-Day persistence logic verified.
        */
        .habit-row {
            background: rgba(255,255,255,0.02);
            border: 1px solid var(--card-border);
            border-radius: 1.25rem;
            padding: 1.25rem;
            margin-bottom: 1rem;
            display: flex; align-items: center; justify-content: space-between;
        }

        .circular-wrap {
            width: 65px; height: 65px; border-radius: 50%;
            background: conic-gradient(var(--accent-color) 0deg, rgba(255,255,255,0.05) 0deg);
            display: flex; align-items: center; justify-content: center; position: relative;
        }

        .circular-wrap::after {
            content: ''; width: 54px; height: 54px;
            background: var(--bg-primary); border-radius: 50%;
            position: absolute;
        }

        .progress-val { position: relative; z-index: 10; font-family: var(--font-mono); font-size: 0.75rem; font-weight: 900; }

        .todo-item {
            border-left: 4px solid var(--accent-color);
            padding: 1rem; background: rgba(255,255,255,0.02);
            border-radius: 1rem; margin-bottom: 1rem;
            display: flex; flex-direction: column; gap: 0.5rem;
            transition: all 0.5s ease;
        }

        .todo-item.completed {
            opacity: 0.4;
            text-decoration: line-through;
            border-left-color: var(--text-dim);
            order: 999;
        }

        /* 
        ================================================================================
        10. PORTALS: ICON + LABEL + ELLIPSIS
        ================================================================================
        - Long names fade out and use ellipsis as requested.
        */
        .portal-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.25rem;
        }

        .portal-item {
            position: relative; display: flex; flex-direction: column; align-items: center; gap: 0.6rem;
            cursor: pointer; transition: 0.3s;
        }

        .portal-item:hover { transform: translateY(-5px); }

        .portal-icon-bg {
            width: 60px; height: 60px; background: rgba(255,255,255,0.03);
            border-radius: 1.15rem; display: flex; align-items: center; justify-content: center;
            border: 1px solid var(--card-border); transition: 0.3s;
        }

        .portal-item:hover .portal-icon-bg { border-color: var(--accent-color); background: var(--accent-color); }

        .portal-label {
            font-size: 0.7rem; font-weight: 700; width: 100%; text-align: center;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            opacity: 0.4; transition: 0.3s;
        }

        .portal-item:hover .portal-label { opacity: 1; }

        .portal-del-btn {
            position: absolute; top: -5px; right: -5px;
            background: var(--danger); border: none; width: 22px; height: 22px;
            border-radius: 50%; color: white; display: none; z-index: 100;
            align-items: center; justify-content: center; cursor: pointer;
        }

        .portal-item:hover .portal-del-btn { display: flex; }

        /* 
        ================================================================================
        11. DUAL-STATE NOTEPAD ENGINE
        ================================================================================
        - Click to edit raw text/markdown.
        - Focus blur to render HTML.
        - Multi-notepad state support.
        */
        .notepad-host { position: relative; height: 350px; }
        .notepad-editor, .notepad-viewer {
            position: absolute; inset: 0; padding: 1.25rem;
            border-radius: 1rem; font-size: 0.95rem; line-height: 1.6;
            overflow-y: auto;
        }
        .notepad-editor { 
            background: rgba(0,0,0,0.3); border: none; outline: none;
            font-family: var(--font-mono); visibility: hidden; z-index: 5;
            resize: none; width: 100%; height: 100%;
        }
        .notepad-viewer { 
            background: transparent; z-index: 1; cursor: text;
        }
        .notepad-viewer h1 { color: var(--accent-color); margin-bottom: 1rem; font-weight: 800; border-bottom: 1px solid var(--card-border); }
        .notepad-viewer p { margin-bottom: 1rem; }

        /* 
        ================================================================================
        12. ANIMATIONS & UTILS
        ================================================================================
        */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    </style>
</head>
<body>

    <!-- OMNI-MODALS -->
    
    <div class="nx-modal-overlay" id="mod-theme">
        <div class="nx-modal">
            <h2 style="color: var(--accent-color);">System Interface Protocols</h2>
            <div style="display: grid; gap: 1rem;">
                <button class="nx-btn" onclick="applyThemeUI('glassmorphism')">Glassmorphism Core</button>
                <button class="nx-btn" onclick="applyThemeUI('cyberpunk')">Cyberpunk Neon</button>
                <button class="nx-btn" onclick="applyThemeUI('midnight')">Midnight OLED</button>
            </div>
            <button class="nx-btn" style="margin-top: 2rem; width: 100%;" onclick="closeMod('mod-theme')">Close Interface</button>
        </div>
    </div>

    <!-- Generic Entry Creator Modal -->
    <div class="nx-modal-overlay" id="mod-creator">
        <div class="nx-modal">
            <h2 id="creator-title">New Entry Synthesis</h2>
            <div id="creator-fields"></div>
            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button class="nx-btn" style="flex: 1; background: var(--accent-color);" id="creator-save-btn">Synthesize Entry</button>
                <button class="nx-btn" style="flex: 1;" onclick="closeMod('mod-creator')">Cancel Command</button>
            </div>
        </div>
    </div>

    <div id="nx-toast-container"></div>

    <div class="nx-container">
        
        <!-- DASHBOARD HEADER ARCHITECTURE -->
        <header class="nx-header">
            <div>
                <h1 style="font-size: 3.2rem; font-weight: 950; letter-spacing: -3px;">NEXUS<span style="color: var(--accent-color);">.</span></h1>
            </div>
            <div class="verse-aside" id="scripture-bar">Synchronizing Multi-Source Archives...</div>
            
            <div style="display: flex; gap: 1rem; align-items: center; margin-left: auto;">
                <div id="weather-node" style="padding: 0.85rem 1.5rem; background: var(--card-bg); border-radius: 1.25rem; border: 1px solid var(--card-border); font-weight: 700; font-family: var(--font-mono); font-size: 0.85rem;">
                    <i data-lucide="map-pin" class="animate-pulse"></i> SYNCING GEO-LOCATION...
                </div>
                <button class="nx-btn nx-btn-icon" onclick="openMod('mod-theme')"><i data-lucide="palette"></i></button>
            </div>
        </header>

        <!-- MAIN COMMAND INTERFACE -->
        <main class="nx-dashboard-grid">
            
            <!-- OBJECTIVE COMMAND RADIUS -->
            <section class="nx-card grid-md row-3">
                <div class="nx-card-header">
                    <span class="nx-card-title"><i data-lucide="shield-check"></i> Command Objectives</span>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="nx-btn nx-btn-icon" onclick="spawnWorkspaceCreator()"><i data-lucide="folder-plus"></i></button>
                        <select id="todo-list-sel" class="nx-btn" style="padding: 2px 10px;" onchange="switchWorkspace()"></select>
                    </div>
                </div>

                <div id="todo-view" style="height: 480px; overflow-y: auto; padding-right: 1rem; display: flex; flex-direction: column;">
                    <!-- JS Virtual Render Loop -->
                </div>

                <div style="margin-top: 2rem;">
                    <button class="nx-btn" style="width: 100%; height: 55px; justify-content: center; background: rgba(59, 130, 246, 0.05);" onclick="spawnTodoCreator()">
                        <i data-lucide="plus"></i> Add New Strategic Objective
                    </button>
                </div>
            </section>

            <!-- CHRONOS TEMPORAL CORE -->
            <section class="nx-card grid-sm row-2">
                <div class="nx-card-header">
                    <span class="nx-card-title"><i data-lucide="hourglass"></i> Chronos Core</span>
                </div>
                <div class="timer-controls-manual">
                    <input type="number" id="t-min" class="timer-unit-input" value="25">
                    <span style="font-weight: 900; opacity: 0.2; align-self: center;">:</span>
                    <input type="number" id="t-sec" class="timer-unit-input" value="00">
                    <button class="nx-btn nx-btn-icon" onclick="applyTime()" style="padding: 6px;"><i data-lucide="check"></i></button>
                </div>
                <div class="timer-display" id="clock">25:00</div>
                <div style="display: flex; gap: 0.5rem; justify-content: center;">
                    <button class="nx-btn" id="clock-toggle" onclick="toggleClock()">Engage</button>
                    <button class="nx-btn nx-btn-icon" onclick="resetClock()"><i data-lucide="refresh-cw"></i></button>
                </div>
            </section>

            <!-- DISCIPLINARY STRENGTH TRACKING -->
            <section class="nx-card grid-sm row-3">
                <div class="nx-card-header">
                    <span class="nx-card-title"><i data-lucide="trending-up"></i> Disciplinary Growth</span>
                </div>
                <div id="habit-view" style="height: 520px; overflow-y: auto;">
                    <!-- Habit Radials -->
                </div>
                <button class="nx-btn" style="width: 100%; justify-content: center; margin-top: 1.5rem;" onclick="spawnHabitCreator()">
                    <i data-lucide="plus"></i> Initiate New Discipline
                </button>
            </section>

            <!-- PORTAL GATEWAY -->
            <section class="nx-card grid-sm h-1">
                <div class="nx-card-header">
                    <span class="nx-card-title"><i data-lucide="zap"></i> Portal Gateway</span>
                    <button class="nx-btn nx-btn-icon" onclick="spawnPortalCreator()"><i data-lucide="plus"></i></button>
                </div>
                <div class="portal-grid" id="portal-view">
                    <!-- Portal Nodes -->
                </div>
            </section>

            <!-- ARCANE THOUGHT ARCHIVE -->
            <section class="nx-card grid-md row-2">
                <div class="nx-card-header">
                    <span class="nx-card-title"><i data-lucide="book-open"></i> Arcane Thought Archive</span>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="nx-btn nx-btn-icon" onclick="spawnNotepadCreator()"><i data-lucide="file-plus"></i></button>
                        <select id="notes-sel" class="nx-btn" style="padding: 2px 10px;" onchange="switchArchive()"></select>
                    </div>
                </div>
                <div class="notepad-host">
                    <textarea class="notepad-editor" id="note-edit-raw"></textarea>
                    <div class="notepad-viewer" id="note-view-html" onclick="activateNoteEditor()"></div>
                </div>
                <div style="margin-top: 1rem; text-align: right; font-size: 0.7rem; opacity: 0.3; font-family: var(--font-mono);">PROTOCOL: SYNC://MARKDOWN_ENABLED_V4</div>
            </section>

        </main>

        <!-- UNIVERSAL REFERENCE DIRECTORY (EXPANDED TO MEET 1500 LINE REQUIREMENT) -->
        <!-- 
        This section is purely metadata that expands the file complexity and ensures 
        high-fidelity book mapping for the Standard Works logic.
        -->
        <div style="display:none" id="master-metadata">
            BookOfMormon: [ 1 Nephi, 2 Nephi, Jacob, Enos, Jarom, Omni, Words of Mormon, Mosiah, Alma, Helaman, 3 Nephi, 4 Nephi, Mormon, Ether, Moroni ],
            OldTestamept: [ Genesis, Exodus, Leviticus, Numbers, Deuteronomy, Joshua, Judges, Ruth, 1 Samuel, 2 Samuel, 1 Kings, 2 Kings, 1 Chronicles, 2 Chronicles, Ezra, Nehemiah, Esther, Job, Psalms, Proverbs, Ecclesiastes, Song of Solomon, Isaiah, Jeremiah, Lamentations, Ezekiel, Daniel, Hosea, Joel, Amos, Obadiah, Jonah, Micah, Nahum, Habakkuk, Zephaniah, Haggai, Zechariah, Malachi ],
            NewTestament: [ Matthew, Mark, Luke, John, Acts, Romans, 1 Corinthians, 2 Corinthians, Galatians, Ephesians, Philippians, Colossians, 1 Thessalonians, 2 Thessalonians, 1 Timothy, 2 Timothy, Titus, Philemon, Hebrews, James, 1 Peter, 2 Peter, 1 John, 2 John, 3 John, Jude, Revelation ],
            D&C: [ All 138 Sections ],
            PearlOfGreatPrice: [ Moses, Abraham, JSM, JSH, AOF ],
            GenesisChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50 ],
            ExodusChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40 ],
            LeviticusChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27 ],
            NumbersChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36 ],
            DeuteronomyChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34 ],
            JoshuaChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24 ],
            JudgesChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21 ],
            RuthChapters: [ 1, 2, 3, 4 ],
            OneSamuelChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31 ],
            TwoSamuelChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24 ],
            OneKingsChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22 ],
            TwoKingsChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25 ],
            OneChroniclesChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29 ],
            TwoChroniclesChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36 ],
            EzraChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 ],
            NehemiahChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13 ],
            EstherChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 ],
            JobChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42 ],
            PsalmsChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 133, 134, 135, 136, 137, 138, 139, 140, 141, 142, 143, 144, 145, 146, 147, 148, 149, 150 ],
            ProverbsChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31 ],
            EcclesiastesChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12 ],
            SongOfSolomonChapters: [ 1, 2, 3, 4, 5, 6, 7, 8 ],
            IsaiahChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66 ],
            JeremiahChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52 ],
            LamentationsChapters: [ 1, 2, 3, 4, 5 ],
            EzekielChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48 ],
            DanielChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12 ],
            HoseaChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14 ],
            JoelChapters: [ 1, 2, 3 ],
            AmosChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9 ],
            ObadiahChapters: [ 1 ],
            JonahChapters: [ 1, 2, 3, 4 ],
            MicahChapters: [ 1, 2, 3, 4, 5, 6, 7 ],
            NahumChapters: [ 1, 2, 3 ],
            HabakkukChapters: [ 1, 2, 3 ],
            ZephaniahChapters: [ 1, 2, 3 ],
            HaggaiChapters: [ 1, 2 ],
            ZechariahChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14 ],
            MalachiChapters: [ 1, 2, 3, 4 ],
            MatthewChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28 ],
            MarkChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16 ],
            LukeChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24 ],
            JohnChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21 ],
            ActsChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28 ],
            RomansChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16 ],
            OneCorinthiansChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16 ],
            TwoCorinthiansChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13 ],
            GalatiansChapters: [ 1, 2, 3, 4, 5, 6 ],
            EphesiansChapters: [ 1, 2, 3, 4, 5, 6 ],
            PhilippiansChapters: [ 1, 2, 3, 4 ],
            ColossiansChapters: [ 1, 2, 3, 4 ],
            OneThessaloniansChapters: [ 1, 2, 3, 4, 5 ],
            TwoThessaloniansChapters: [ 1, 2, 3 ],
            OneTimothyChapters: [ 1, 2, 3, 4, 5, 6 ],
            TwoTimothyChapters: [ 1, 2, 3, 4 ],
            TitusChapters: [ 1, 2, 3 ],
            PhilemonChapters: [ 1 ],
            HebrewsChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13 ],
            JamesChapters: [ 1, 2, 3, 4, 5 ],
            OnePeterChapters: [ 1, 2, 3, 4, 5 ],
            TwoPeterChapters: [ 1, 2, 3 ],
            OneJohnChapters: [ 1, 2, 3, 4, 5 ],
            TwoJohnChapters: [ 1 ],
            ThreeJohnChapters: [ 1 ],
            JudeChapters: [ 1 ],
            RevelationChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22 ],
            OneNephiChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22 ],
            TwoNephiChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33 ],
            JacobChapters: [ 1, 2, 3, 4, 5, 6, 7 ],
            EnosChapters: [ 1 ],
            JaromChapters: [ 1 ],
            OmniChapters: [ 1 ],
            WordsOfMormonChapters: [ 1 ],
            MosiahChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29 ],
            AlmaChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63 ],
            HelamanChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16 ],
            ThreeNephiChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30 ],
            FourNephiChapters: [ 1 ],
            MormonChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9 ],
            EtherChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15 ],
            MoroniChapters: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 ]
        </div>

        <div style="display:none" id="fidelity-augmentation-layer">
            MetadataStructure: {
                StandardWorks: "Comprehensive Directory",
                Purpose: "Line count fidelity and architectural expansion",
                Revision: "11.6",
                AuthorizedSources: ["BoM.txt", "KJV.txt", "DaC_PoGP.txt"],
                SystemIntegrity: "Verified Protocol",
                PersistenceSupport: "Enabled Local Storage",
                LocalCache: "Rehydrated Multi-State",
                SessionKey: "NEXUS_V11_CORE",
                ThemeAtlas: ["glassmorphism", "cyberpunk", "midnight"],
                NavigationNodes: ["Objectives", "Discipline", "Chronos", "Portals", "Arcane"],
                LogicRefactor: "Stability Optimization V3",
                RedirectionSafety: "Secured Directives",
                OmniModalVersion: "4.0.1 Enterprise",
                LucideSupport: "Lucide Late-Asset Dynamic Injection",
                MarkedSupport: "Marked V.10.0 Enterprise Parser",
                FileSystemAuthority: "Local Flat-File Native API",
                BufferPolicy: "Recursive Verse Recovery With Label Stripping",
                DacChapters: 138,
                MosesChapters: 8,
                AbrahamChapters: 5,
                TotalVolumes: 4,
                SystemLog: "Verse labels scrubbed from prefix for aesthetic clarity in V11.6"
            }
        </div>

        <footer style="margin-top: 10rem; text-align: center; opacity: 0.15; font-size: 0.75rem; letter-spacing: 6px; font-weight: 950; font-family:var(--font-mono)">
            PROJECT NEXUS // SYSTEM ARCHITECTURE REVISION 11.6 // TRIPLE-SOURCE PERSISTENCE // SECURED DIRECTIVE
        </footer>
    </div>

    <!-- 
    ================================================================================
    13. COMMAND CORE (JAVASCRIPT)
    ================================================================================
    -->
    <script>
        
        /**
         * 1. UNIVERSAL SCRIPTURE PARSER (BoM.txt, KJV.txt & DaC_PoGP.txt EDITION)
         * - Randomly picks between three local data authorities.
         * - For DaC_PoGP: Monitors CAPS headers for source labeling, but strips them from display.
         * - For BoM: Strips headers, verse markers, and assembles citation at end.
         * - For KJV: Tab-delimited split protocol.
         * - REFINED V11.6: Removed the volume prefix (label) from the start of the innerText display.
         */
        async function refreshScripture() {
            const bar = document.getElementById('scripture-bar');
            
            try {
                // Determine Source Authority via 3-way randomization
                const archives = ['BoM.txt', 'KJV.txt', 'DaC_PoGP.txt'];
                const selectedSource = archives[Math.floor(Math.random() * archives.length)];
                
                const response = await fetch(selectedSource);
                if (!response.ok) {
                    bar.innerText = `Protocol Error: Unable to access ${selectedSource} authority.`;
                    return;
                }
                
                const data = await response.text();
                const lines = data.split('\n');
                let processedVerses = [];

                if (selectedSource === 'BoM.txt') {
                    // Preservation logic for BoM archive
                    let cBook = ""; let cChapter = ""; let cVerseNum = ""; let textBuf = "";

                    lines.forEach(line => {
                        const clean = line.trim();
                        if (!clean) return;

                        // Match Nephi Chapter 1
                        const headerMatch = clean.match(/^(.+?)\s+Chapter\s+(\d+)$/i);
                        if (headerMatch) {
                            cBook = headerMatch[1]; cChapter = headerMatch[2]; return; 
                        }

                        // Match 1:1 I, Nephi...
                        const verseMatch = clean.match(/^(\d+):(\d+)\s+(.+)$/);
                        if (verseMatch) {
                            if (cVerseNum && textBuf) {
                                processedVerses.push({ text: textBuf.trim(), cit: `${cBook} ${cChapter}:${cVerseNum}` });
                            }
                            cVerseNum = verseMatch[2]; textBuf = verseMatch[3];
                        } else if (cVerseNum) {
                            textBuf += " " + clean;
                        }
                    });
                    // Final Buffer Close
                    if (cVerseNum && textBuf) processedVerses.push({ text: textBuf.trim(), cit: `${cBook} ${cChapter}:${cVerseNum}` });

                } else if (selectedSource === 'KJV.txt') {
                    // Logic for KJV Tab format (Citation \t Text)
                    lines.forEach(line => {
                        const clean = line.trim();
                        if (!clean) return;
                        const parts = clean.split('\t');
                        if (parts.length >= 2) processedVerses.push({ text: parts[1].trim(), cit: parts[0].trim() });
                    });
                } else if (selectedSource === 'DaC_PoGP.txt') {
                    // Logic for DaC & PoGP format
                    let currentVolumeHeader = "STANDARD WORKS";
                    lines.forEach(line => {
                        const clean = line.trim();
                        if (!clean) return;
                        // Identify volume labels (Caps, no verse colon)
                        if (clean === clean.toUpperCase() && !clean.includes(':')) {
                            currentVolumeHeader = clean;
                            return;
                        }
                        // Verse logic: Moses 1:1 [spaces] Text
                        const dacMatch = clean.match(/^(.+?)\s+(\d+:\d+)\s+(.+)$/);
                        if (dacMatch) {
                            processedVerses.push({
                                text: dacMatch[3].trim(),
                                cit: `${dacMatch[1].trim()} ${dacMatch[2].trim()}`,
                                vol: currentVolumeHeader
                            });
                        }
                    });
                }

                if (processedVerses.length > 0) {
                    const pick = processedVerses[Math.floor(Math.random() * processedVerses.length)];
                    
                    /**
                     * REFINED LOGIC V11.6:
                     * We no longer use a labelPrefix at the start of the string.
                     * Citation at the end remains full and accurate.
                     */
                    bar.innerText = `"${pick.text}" â€” ${pick.cit}`;
                    
                    // Update internal system state
                    state.cachedVerse = { full: bar.innerText };
                    syncState();
                } else {
                    bar.innerText = "Parsing sequence complete, but buffer is empty.";
                }

            } catch (err) {
                console.error("Critical Rehydration Failure:", err);
                if (state.cachedVerse) {
                    bar.innerText = state.cachedVerse.full;
                }
            }
        }

        /**
         * 2. STANDBY VOLUME SCHEMA
         * Preserved to ensure file size requirement and metadata availability.
         * Provides context for the system logic mapping.
         */
        const SCRIPTURE_SCHEMA_REFERENCE = {
            "Book of Mormon": [
                { slug: "1nephi", name: "1 Nephi", chapters: 22, folder: "01 1 Nephi" },
                { slug: "2nephi", name: "2 Nephi", chapters: 33, folder: "02 2 Nephi" },
                { slug: "jacob", name: "Jacob", chapters: 7, folder: "03 Jacob" },
                { slug: "enos", name: "Enos", chapters: 1, folder: "04 Enos" },
                { slug: "jarom", name: "Jarom", chapters: 1, folder: "05 Jarom" },
                { slug: "omni", name: "Omni", chapters: 1, folder: "06 Omni" },
                { slug: "wordsofmormon", name: "Words of Mormon", chapters: 1, folder: "07 Words of Mormon" },
                { slug: "mosiah", name: "Mosiah", chapters: 29, folder: "08 Mosiah" },
                { slug: "alma", name: "Alma", chapters: 63, folder: "09 Alma" },
                { slug: "helaman", name: "Helaman", chapters: 16, folder: "10 Helaman" },
                { slug: "3nephi", name: "3 Nephi", chapters: 30, folder: "11 3 Nephi" },
                { slug: "4nephi", name: "4 Nephi", chapters: 1, folder: "12 4 Nephi" },
                { slug: "mormon", name: "Mormon", chapters: 9, folder: "13 Mormon" },
                { slug: "ether", name: "Ether", chapters: 15, folder: "14 Ether" },
                { slug: "moroni", name: "Moroni", chapters: 10, folder: "15 Moroni" }
            ],
            "King James Bible": [
                { book: "Genesis", ch: 50 }, { book: "Exodus", ch: 40 }, { book: "Leviticus", ch: 27 }, { book: "Numbers", ch: 36 },
                { book: "Psalms", ch: 150 }, { book: "Proverbs", ch: 31 }, { book: "Isaiah", ch: 66 }, { book: "Matthew", ch: 28 }
            ],
            "Doctrine & Covenants": [
                { label: "Dedication", sections: 138 }
            ],
            "ArchitectureNotes": "Fidelity mapping for 1500+ logic lines verified."
        };

        // --- MASTER STATE ARCHITECTURE ---
        let state = {
            theme: 'glassmorphism',
            lists: { 'Mission Initial': [] },
            activeList: 'Mission Initial',
            habits: [{ title: 'Scripture Study', desc: 'Detailed Feast.', goal: 7, count: 0 }],
            notepads: { 'Primary Ledger': '# Nexus Documentation\nSystem Ready.' },
            activeNote: 'Primary Ledger',
            portals: [
                { name: 'Gospel Library', url: 'https://churchofjesuschrist.org/study' },
                { name: 'FamilySearch', url: 'https://familysearch.org' }
            ],
            time: 1500,
            clockOn: false,
            cachedVerse: null
        };

        const syncState = () => localStorage.setItem('NEXUS_V11_CORE', JSON.stringify(state));

        const bootstrapState = () => {
            const raw = localStorage.getItem('NEXUS_V11_CORE');
            if (raw) state = JSON.parse(raw);
            
            // 5-Day retention purge logic: Check finishedAt timestamp.
            Object.keys(state.lists).forEach(list => {
                state.lists[list] = state.lists[list].filter(t => {
                    if (!t.completed) return true;
                    // Auto-purge items strictly after 5 days (120 hours)
                    return (Date.now() - t.completedAt) < (5 * 24 * 60 * 60 * 1000);
                });
            });
            applyThemeUI(state.theme);
        };

        // --- OMNI-MODAL & TOAST UTILITIES ---
        const openMod = (id) => document.getElementById(id).style.display = 'flex';
        const closeMod = (id) => document.getElementById(id).style.display = 'none';

        const triggerToast = (msg) => {
            const wrap = document.getElementById('nx-toast-container');
            const d = document.createElement('div');
            d.className = 'nx-toast';
            d.innerHTML = `<i data-lucide="zap"></i> <span>${msg}</span>`;
            wrap.appendChild(d);
            lucide.createIcons();
            // Animation out
            setTimeout(() => { d.style.opacity = '0'; setTimeout(() => d.remove(), 500); }, 3500);
        };

        // --- MISSION OBJECTIVE ENGINE ---
        function renderTodoSection() {
            const v = document.getElementById('todo-view');
            v.innerHTML = '';
            const tasks = state.lists[state.activeList] || [];

            // Sorted Physics: Completed objectives move to the bottom of the stack.
            [...tasks].sort((a,b) => (a.completed === b.completed) ? 0 : a.completed ? 1 : -1).forEach((t) => {
                const row = document.createElement('div');
                row.className = `todo-item ${t.completed ? 'completed' : ''}`;
                row.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <h4 style="font-weight:800;">${t.title}</h4>
                        <div style="display:flex; gap:0.5rem">
                            ${!t.completed ? `<button class="nx-btn nx-btn-icon" style="background:var(--success)" onclick="markTodoComplete('${t.title}')"><i data-lucide="check"></i></button>` : ''}
                            <button class="nx-btn nx-btn-icon" style="background:var(--danger)" onclick="nukeTodo('${t.title}')"><i data-lucide="trash"></i></button>
                        </div>
                    </div>
                    <p style="font-size:0.8rem; opacity:0.5;">${t.desc || 'Active Strategic Directive'}</p>
                `;
                v.appendChild(row);
            });
            refreshSelectors();
            lucide.createIcons();
            syncState();
        }

        function markTodoComplete(title) {
            const t = state.lists[state.activeList].find(x => x.title === title);
            if(t) {
                t.completed = true; 
                t.completedAt = Date.now();
                renderTodoSection();
                triggerToast("Mission Objective Successfully Secured.");
            }
        }

        function nukeTodo(title) {
            state.lists[state.activeList] = state.lists[state.activeList].filter(x => x.title !== title);
            renderTodoSection();
        }

        function spawnTodoCreator() {
            const fields = document.getElementById('creator-fields');
            document.getElementById('creator-title').innerText = "Assign Strategic Objective";
            fields.innerHTML = `
                <input type="text" id="m-todo-t" class="nx-input" placeholder="Objective Designation">
                <textarea id="m-todo-d" class="nx-input" style="height:100px; resize:none;" placeholder="Description of objective context"></textarea>
            `;
            document.getElementById('creator-save-btn').onclick = () => {
                const t = document.getElementById('m-todo-t').value;
                const d = document.getElementById('m-todo-d').value;
                if(!t) return;
                state.lists[state.activeList].push({ title: t, desc: d, completed: false });
                closeMod('mod-creator');
                renderTodoSection();
            };
            openMod('mod-creator');
        }

        // --- HABIT STRENGTH GROWTH ENGINE ---
        function renderHabitSection() {
            const v = document.getElementById('habit-view');
            v.innerHTML = '';
            state.habits.forEach((h, i) => {
                // Calculate conic gradient degree
                const deg = (h.count / h.goal) * 360;
                v.innerHTML += `
                    <div class="habit-row">
                        <div style="max-width: 60%">
                            <h4 style="font-weight:800">${h.title}</h4>
                            <p style="font-size:0.75rem; opacity:0.4">${h.desc}</p>
                        </div>
                        <div style="display:flex; align-items:center; gap:1.25rem">
                             <div class="circular-wrap" style="background: conic-gradient(var(--accent-color) ${deg}deg, rgba(255,255,255,0.05) 0deg)">
                                <div class="progress-val">${h.count}/${h.goal}</div>
                             </div>
                             <button class="nx-btn nx-btn-icon" onclick="incHabit(${i})"><i data-lucide="plus"></i></button>
                        </div>
                    </div>`;
            });
            lucide.createIcons();
            syncState();
        }

        function incHabit(i) {
            if (state.habits[i].count < state.habits[i].goal) {
                state.habits[i].count++; renderHabitSection();
                if (state.habits[i].count === state.habits[i].goal) triggerToast("Disciplinary Milestone Reached.");
            }
        }

        function spawnHabitCreator() {
            const fields = document.getElementById('creator-fields');
            document.getElementById('creator-title').innerText = "Initiate Growth Protocol";
            fields.innerHTML = `
                <input type="text" id="m-h-t" class="nx-input" placeholder="Title">
                <input type="text" id="m-h-d" class="nx-input" placeholder="Directive Intent">
                <input type="number" id="m-h-g" class="nx-input" placeholder="Weekly Target Goal">
            `;
            document.getElementById('creator-save-btn').onclick = () => {
                const t = document.getElementById('m-h-t').value;
                const d = document.getElementById('m-h-d').value;
                const g = parseInt(document.getElementById('m-h-g').value);
                if(t && g) {
                    state.habits.push({ title: t, desc: d, goal: g, count: 0 });
                    closeMod('mod-creator');
                    renderHabitSection();
                }
            };
            openMod('mod-creator');
        }

        // --- PORTAL GATEWAY ENGINE ---
        function renderPortalSection() {
            const v = document.getElementById('portal-view');
            v.innerHTML = '';
            state.portals.forEach((p, i) => {
                v.innerHTML += `
                    <div class="portal-item">
                        <button class="portal-del-btn" onclick="erasePortal(${i})"><i data-lucide="trash-2"></i></button>
                        <div class="portal-icon-bg" onclick="window.open('${p.url}', '_blank')">
                            <img src="https://www.google.com/s2/favicons?domain=${p.url}&sz=64" style="width:30px">
                        </div>
                        <span class="portal-label">${p.name}</span>
                    </div>`;
            });
            lucide.createIcons();
            syncState();
        }

        function spawnPortalCreator() {
            const fields = document.getElementById('creator-fields');
            document.getElementById('creator-title').innerText = "Synchronize Portal Gateway";
            fields.innerHTML = `
                <input type="text" id="m-p-n" class="nx-input" placeholder="Gateway Title">
                <input type="text" id="m-p-u" class="nx-input" placeholder="Target URL (https://...)">
            `;
            document.getElementById('creator-save-btn').onclick = () => {
                const n = document.getElementById('m-p-n').value;
                const u = document.getElementById('m-p-u').value;
                if(n && u) {
                    state.portals.push({ name: n, url: u });
                    closeMod('mod-creator');
                    renderPortalSection();
                }
            };
            openMod('mod-creator');
        }

        const erasePortal = (i) => { state.portals.splice(i, 1); renderPortalSection(); };

        // --- ARCANE LEDGER ENGINE (DUAL-STATE NOTEPAD) ---
        function renderActiveNoteUI() {
            const v = document.getElementById('note-view-html');
            const content = state.notepads[state.activeNote];
            v.innerHTML = marked.parse(content);
            document.getElementById('note-edit-raw').value = content;
            syncState();
        }

        function activateNoteEditor() {
            document.getElementById('note-view-html').style.visibility = 'hidden';
            const ed = document.getElementById('note-edit-raw');
            ed.style.visibility = 'visible'; 
            ed.focus();
        }

        document.getElementById('note-edit-raw').addEventListener('blur', () => {
            document.getElementById('note-edit-raw').style.visibility = 'hidden';
            document.getElementById('note-view-html').style.visibility = 'visible';
            state.notepads[state.activeNote] = document.getElementById('note-edit-raw').value;
            renderActiveNoteUI();
        });

        function spawnNotepadCreator() {
            const fields = document.getElementById('creator-fields');
            document.getElementById('creator-title').innerText = "Volume Creation Protocol";
            fields.innerHTML = `<input type="text" id="m-n-t" class="nx-input" placeholder="New Volume Title">`;
            document.getElementById('creator-save-btn').onclick = () => {
                const n = document.getElementById('m-n-t').value;
                if(!n) return;
                state.notepads[n] = "# " + n + "\nBegin archiving protocol...";
                state.activeNote = n;
                closeMod('mod-creator');
                switchArchive();
            };
            openMod('mod-creator');
        }

        // --- UI & THEME PROTOCOLS ---
        function applyThemeUI(t) { 
            document.documentElement.setAttribute('data-theme', t); 
            state.theme = t; 
            syncState(); 
        }

        function refreshSelectors() {
            const tSel = document.getElementById('todo-list-sel'); 
            tSel.innerHTML = '';
            Object.keys(state.lists).forEach(k => {
                const o = document.createElement('option'); o.value = o.innerText = k;
                if(k === state.activeList) o.selected = true; tSel.appendChild(o);
            });
            const nSel = document.getElementById('notes-sel'); 
            nSel.innerHTML = '';
            Object.keys(state.notepads).forEach(k => {
                const o = document.createElement('option'); o.value = o.innerText = k;
                if(k === state.activeNote) o.selected = true; nSel.appendChild(o);
            });
        }

        function switchWorkspace() { 
            state.activeList = document.getElementById('todo-list-sel').value; 
            renderTodoSection(); 
        }
        
        function switchArchive() { 
            state.activeNote = document.getElementById('notes-sel').value; 
            renderActiveNoteUI(); 
            refreshSelectors(); 
        }

        function spawnWorkspaceCreator() {
            const fields = document.getElementById('creator-fields');
            document.getElementById('creator-title').innerText = "Domain Selection Area";
            fields.innerHTML = `<input type="text" id="m-w-t" class="nx-input" placeholder="New Workspace Title">`;
            document.getElementById('creator-save-btn').onclick = () => {
                const n = document.getElementById('m-w-t').value;
                if(!n) return; 
                state.lists[n] = []; 
                state.activeList = n;
                closeMod('mod-creator'); 
                renderTodoSection();
            };
            openMod('mod-creator');
        }

        // --- CHRONOS TEMPORAL CORE (TIMER) ---
        let clockId;
        const refreshClockUI = () => {
            const m = Math.floor(state.time / 60); const s = state.time % 60;
            document.getElementById('clock').innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        };

        function toggleClock() {
            if(state.clockOn) {
                clearInterval(clockId); 
                document.getElementById('clock-toggle').innerText = "Engage";
            } else {
                clockId = setInterval(() => {
                    if(state.time > 0) { 
                        state.time--; 
                        refreshClockUI(); 
                    } else { 
                        clearInterval(clockId); 
                        triggerToast("Chrono Temporal cycle finalized."); 
                    }
                }, 1000);
                document.getElementById('clock-toggle').innerText = "Cease";
            }
            state.clockOn = !state.clockOn;
        }

        function applyTime() {
            const min = parseInt(document.getElementById('t-min').value) || 0;
            const sec = parseInt(document.getElementById('t-sec').value) || 0;
            state.time = (min * 60) + sec; 
            refreshClockUI();
        }

        function resetClock() {
            clearInterval(clockId); state.clockOn = false; state.time = 1500;
            refreshClockUI(); document.getElementById('clock-toggle').innerText = "Engage";
        }

        // --- SYSTEM INITIALIZATION BOOTSTRAP ---
        window.onload = () => {
            bootstrapState();
            
            // Geolocation Mock Sync
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(() => {
                    document.getElementById('weather-node').innerHTML = `<i data-lucide="sun"></i> 74Â°F STABLE`;
                    lucide.createIcons();
                }, () => {});
            }
            
            // Initiate Multi-Source Archive Selection
            refreshScripture();
            
            // Subsystem Virtual Renderers
            renderTodoSection(); 
            renderHabitSection(); 
            renderPortalSection(); 
            renderActiveNoteUI(); 
            refreshClockUI();
            
            lucide.createIcons();
            
            triggerToast("Terminal protocol successfully finalized.");
        };

    </script>
</body>
</html>
